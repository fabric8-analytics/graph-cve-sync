#!/usr/bin/env python3
# Copyright Â© 2020 Red Hat Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# Author: Yusuf Zainee <yzainee@redhat.com>
#

"""Script which fetches the feed from snyk and stores it in S3 bucket."""

import os
import jwt
import time
import requests
import logging
import json
from datetime import datetime
from graph_snyk_cve_sync import SnykCveSync
from helper import Helper

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class SnykDataFetcher:
    """Snyk data class to fetch the information from Snyk."""

    def __init__(self):
        """Init function to add default values."""
        self.helper = Helper()
        self.snyk_data = {}
        self.URL = os.environ.get('SNYK_URL', '')
        self.ISS = os.environ.get('SNYK_ISS', '')
        self.TOKEN = os.environ.get('SNYK_TOKEN', '')
        self.SAVE_FILE = os.environ.get('SNYK_FEED_SAVE_DAYS', '5')
        self.DISABLE_SNYK_SYNC_OPERATION = os.environ.get('DISABLE_SNYK_SYNC_OPERATION', 'false')\
            .lower() in ('1', 'yes', 'true')

    def _validate(self):
        """Validate method to see all the params are set.
        :return True if all params are valid. Raise exception otherwise & halt proceedings."""
        try:
            assert self.URL
            assert self.ISS
            assert self.TOKEN
        except AssertionError:
            raise ValueError('Snyk Feed fetch aborted. Either URL, ISS or TOKEN missing')
        logger.info("Snyk credentials validated.")
        return True

    def _fetch(self):
        """Fetch function to fetch the feed from Snyk.
        :return True if the operation to fetch & store is successful. Exception otherwise."""
        payload = {
            'iss': self.ISS,
            'iat': int(time.time())
        }
        jwt_token = jwt.encode(
            payload,
            self.TOKEN,
            algorithm='HS256'
        )
        headers = {
            'Authorization': jwt_token
        }
        try:
            res = requests.get(self.URL, headers=headers)
        except Exception as e:
            logger.error('Unable to get snyk feed. Reason: %r' % e)
            return False
        logger.info("Snyk feed successfully fetched.")
        self.snyk_data = json.loads(res.text)
        return True

    def _run_snyk_ingestion(self):
        """Run the process of parsing and ingesting snyk data."""
        logger.info("Triggering Snyk ingestion.")
        return SnykCveSync(self.snyk_data).run_snyk_sync()

    def _store_data(self):
        """Store the snyk data into the respective S3 bucket."""
        utc_now = datetime.utcnow()
        day = str(utc_now.weekday())
        if day == "6":
            self.helper.store_json_content(self.snyk_data, "snyk-feed/" +
                                           utc_now.strftime('%d-%m-%Y') + ".json")
            logger.info("Snyk feed saved in S3.")

    def _disable_snyk_run(self, date):
        """Enable or disable snyk run.
        :return True if this needs to be run forcefully or if its saturday midnight.
        False otherwise."""
        logger.info("Disable Snyk Sync {}".format(self.DISABLE_SNYK_SYNC_OPERATION))
        logger.info("Force Snyk Run {}".format(self.helper.force_run_ingestion()))
        logger.info("Current Hour {}".format(date.strftime('%H')))
        logger.info("Ingestion Run Time {}".format(self.helper.ingestion_run_time()))
        if self.DISABLE_SNYK_SYNC_OPERATION:
            return True
        force = self.helper.force_run_ingestion()
        if force:
            return False
        return date.strftime('%H') != self.helper.ingestion_run_time()

    def run_snyk_fetch(self):
        """Entry function for the snyk fetch feed.
        :return Success message for completion of task."""
        logger.info("Snyk Feed Fetch Function".center(50, '-'))
        self._validate()
        utc_now = datetime.utcnow()
        if self._disable_snyk_run(utc_now):
            logger.info("Snyk feed wont be fetched at this time.")
            return
        logger.info("Snyk Feed Fetch Begins")
        if self._fetch():
            self._run_snyk_ingestion()
            self._store_data()
        return "Success"
